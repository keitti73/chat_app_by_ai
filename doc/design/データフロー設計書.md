# ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª - ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆæ›¸

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹æ§˜ã€…ãªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã‚’è©³ç´°ã«èª¬æ˜ã—ã€Mermaidã‚’ä½¿ç”¨ã—ã¦è¦–è¦šåŒ–ã—ã¾ã™ã€‚

## 1. åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼æ¦‚è¦

### 1.1 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TB
    subgraph "Frontend Layer"
        A[React Components] --> B[GraphQL Client<br/>Apollo Client]
        B --> C[State Management<br/>Local State + Cache]
    end
    
    subgraph "Network Layer"
        C --> D[HTTP/WebSocket<br/>GraphQL over HTTPS]
        D --> E[CDN/CloudFront<br/>Edge Caching]
    end
    
    subgraph "API Gateway Layer"
        E --> F[AWS AppSync<br/>GraphQL API]
        F --> G[Schema Validation<br/>Query Parsing]
        G --> H[Authentication<br/>JWT Token Validation]
    end
    
    subgraph "Business Logic Layer"
        H --> I[JavaScript Resolvers<br/>Business Rules]
        I --> J[Data Transformation<br/>Request/Response Mapping]
    end
    
    subgraph "Data Access Layer"
        J --> K[DynamoDB Client<br/>SDK Operations]
        K --> L[Database Operations<br/>Query/Scan/Put/Update]
    end
    
    subgraph "Storage Layer"
        L --> M[DynamoDB Tables<br/>Room + Message]
        M --> N[Indexes<br/>GSI for Query Optimization]
        N --> O[Streams<br/>Change Data Capture]
    end
    
    subgraph "Real-time Layer"
        O --> P[Event Processing<br/>Lambda Triggers]
        P --> Q[WebSocket Connections<br/>Subscription Management]
        Q --> A
    end
```

## 2. èªè¨¼ãƒ»èªå¯ãƒ•ãƒ­ãƒ¼è©³ç´°

### 2.1 æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    actor User as ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant UI as ğŸ–¥ï¸ React UI
    participant Apollo as ğŸš€ Apollo Client
    participant Cognito as ğŸ” Cognito User Pool
    participant AppSync as âš¡ AWS AppSync
    participant Validation as âœ… Input Validator
    participant Profile as ğŸ‘¥ User Profile Service
    
    User->>UI: ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ï¼ˆemail, password, usernameï¼‰
    UI->>Validation: å…¥åŠ›å€¤æ¤œè¨¼
    
    alt å…¥åŠ›å€¤ãŒæœ‰åŠ¹
        Validation-->>UI: æ¤œè¨¼æˆåŠŸ
        UI->>Apollo: signUp mutationå®Ÿè¡Œ
        Apollo->>Cognito: createUser APIå‘¼ã³å‡ºã—
        
        alt ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæˆåŠŸ
            Cognito-->>Apollo: ç¢ºèªã‚³ãƒ¼ãƒ‰é€ä¿¡
            Apollo-->>UI: ç¢ºèªãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºè¦æ±‚
            UI-->>User: ç¢ºèªã‚³ãƒ¼ãƒ‰å…¥åŠ›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            
            User->>UI: ç¢ºèªã‚³ãƒ¼ãƒ‰å…¥åŠ›
            UI->>Apollo: confirmSignUpå®Ÿè¡Œ
            Apollo->>Cognito: ç¢ºèªã‚³ãƒ¼ãƒ‰æ¤œè¨¼
            
            alt ç¢ºèªæˆåŠŸ
                Cognito-->>Apollo: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªå®Œäº†
                Apollo->>AppSync: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆ
                AppSync->>Profile: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜
                Profile-->>AppSync: ä¿å­˜å®Œäº†
                AppSync-->>Apollo: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä½œæˆæˆåŠŸ
                Apollo-->>UI: ç™»éŒ²å®Œäº†é€šçŸ¥
                UI-->>User: ğŸ‰ ç™»éŒ²æˆåŠŸç”»é¢
            else ç¢ºèªå¤±æ•—
                Cognito-->>Apollo: ç¢ºèªã‚¨ãƒ©ãƒ¼
                Apollo-->>UI: ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                UI-->>User: âŒ ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼
            end
        else ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå¤±æ•—
            Cognito-->>Apollo: ä½œæˆã‚¨ãƒ©ãƒ¼ï¼ˆé‡è¤‡ç­‰ï¼‰
            Apollo-->>UI: ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            UI-->>User: âŒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼
        end
    else å…¥åŠ›å€¤ãŒç„¡åŠ¹
        Validation-->>UI: æ¤œè¨¼ã‚¨ãƒ©ãƒ¼
        UI-->>User: âŒ å…¥åŠ›ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    end
```

### 2.2 ãƒ­ã‚°ã‚¤ãƒ³ã¨ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ãƒ•ãƒ­ãƒ¼

```mermaid
stateDiagram-v2
    [*] --> Unauthenticated: ã‚¢ãƒ—ãƒªèµ·å‹•
    
    Unauthenticated --> Authenticating: ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
    Authenticating --> Authenticated: èªè¨¼æˆåŠŸ
    Authenticating --> Unauthenticated: èªè¨¼å¤±æ•—
    
    Authenticated --> API_Call: API ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    API_Call --> Token_Valid: ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
    Token_Valid --> API_Success: æœ‰åŠ¹
    Token_Valid --> Token_Refresh: æœŸé™åˆ‡ã‚Œ
    
    Token_Refresh --> Authenticated: ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æˆåŠŸ
    Token_Refresh --> Unauthenticated: ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•—
    
    API_Success --> Authenticated: ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡
    
    Authenticated --> [*]: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    
    note right of Token_Refresh
        Refresh Tokenã‚’ä½¿ç”¨ã—ã¦
        æ–°ã—ã„Access Tokenã‚’å–å¾—
    end note
    
    note right of API_Success
        èªè¨¼æ¸ˆã¿APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®
        æ­£å¸¸ãªå‡¦ç†ãƒ•ãƒ­ãƒ¼
    end note
```

## 3. ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ æ“ä½œãƒ•ãƒ­ãƒ¼

### 3.1 ãƒ«ãƒ¼ãƒ ä½œæˆãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TB
    A[ãƒ«ãƒ¼ãƒ ä½œæˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯] --> B[ãƒ«ãƒ¼ãƒ åå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º]
    B --> C{å…¥åŠ›å€¤æ¤œè¨¼}
    
    C -->|ç„¡åŠ¹| D[ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º]
    D --> B
    
    C -->|æœ‰åŠ¹| E[createRoom Mutationå®Ÿè¡Œ]
    E --> F[AppSync: èªè¨¼ãƒã‚§ãƒƒã‚¯]
    F --> G{èªè¨¼æ¸ˆã¿?}
    
    G -->|No| H[401 Unauthorized]
    H --> I[ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ]
    
    G -->|Yes| J[Resolver: å…¥åŠ›å€¤å†æ¤œè¨¼]
    J --> K[UUIDç”Ÿæˆ]
    K --> L[ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç”Ÿæˆ]
    L --> M[DynamoDB: PutItemå®Ÿè¡Œ]
    
    M --> N{ä¿å­˜æˆåŠŸ?}
    N -->|No| O[500 Internal Server Error]
    O --> P[ã‚¨ãƒ©ãƒ¼é€šçŸ¥è¡¨ç¤º]
    
    N -->|Yes| Q[onRoomCreated Subscriptionç™ºç«]
    Q --> R[å…¨æ¥ç¶šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€šçŸ¥]
    R --> S[ä½œæˆè€…ã«ãƒ«ãƒ¼ãƒ ç”»é¢è¡¨ç¤º]
    R --> T[ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ«ãƒ¼ãƒ ä¸€è¦§æ›´æ–°]
    
    subgraph "Success Indicators"
        U[âœ… ãƒ«ãƒ¼ãƒ ä½œæˆæˆåŠŸ]
        V[ğŸ“¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥]
        W[ğŸ”„ UIè‡ªå‹•æ›´æ–°]
    end
    
    S --> U
    T --> V
    R --> W
```

### 3.2 ãƒ«ãƒ¼ãƒ å‚åŠ ãƒ»é€€å‡ºãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant User as ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant RoomList as ğŸ“‹ ãƒ«ãƒ¼ãƒ ä¸€è¦§
    participant RoomView as ğŸ’¬ ãƒ«ãƒ¼ãƒ ç”»é¢
    participant WebSocket as ğŸ”Œ WebSocketæ¥ç¶š
    participant AppSync as âš¡ AppSync
    participant DynamoDB as ğŸ—„ï¸ DynamoDB
    
    Note over User,DynamoDB: ãƒ«ãƒ¼ãƒ å‚åŠ ãƒ•ãƒ­ãƒ¼
    
    User->>RoomList: ãƒ«ãƒ¼ãƒ é¸æŠãƒ»ã‚¯ãƒªãƒƒã‚¯
    RoomList->>RoomView: ãƒ«ãƒ¼ãƒ ç”»é¢é·ç§»
    RoomView->>WebSocket: WebSocketæ¥ç¶šç¢ºç«‹
    WebSocket->>AppSync: èªè¨¼æƒ…å ±ä»˜ãæ¥ç¶š
    
    AppSync->>AppSync: JWT Tokenæ¤œè¨¼
    AppSync-->>WebSocket: æ¥ç¶šè¨±å¯
    
    RoomView->>AppSync: onMessagePosted Subscriptionç™»éŒ²
    Note over AppSync: roomId: "room_001" ã§ãƒ•ã‚£ãƒ«ã‚¿
    AppSync-->>RoomView: Subscriptionç¢ºç«‹
    
    RoomView->>AppSync: listMessages Queryå®Ÿè¡Œ
    AppSync->>DynamoDB: room-index Query
    DynamoDB-->>AppSync: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´
    AppSync-->>RoomView: å±¥æ­´è¡¨ç¤º
    
    Note over User,DynamoDB: ãƒ«ãƒ¼ãƒ é€€å‡ºãƒ•ãƒ­ãƒ¼
    
    User->>RoomView: ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯/ãƒ«ãƒ¼ãƒ é€€å‡º
    RoomView->>WebSocket: Subscriptionè§£é™¤
    WebSocket->>AppSync: æ¥ç¶šã‚¯ãƒ­ãƒ¼ã‚ºè¦æ±‚
    AppSync-->>WebSocket: è§£é™¤ç¢ºèª
    RoomView->>RoomList: ãƒ«ãƒ¼ãƒ ä¸€è¦§ç”»é¢ã«æˆ»ã‚‹
```

## 4. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ãƒ»ãƒ•ãƒ­ãƒ¼

### 4.1 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ•ç¨¿ãƒ•ãƒ­ãƒ¼è©³ç´°

```mermaid
flowchart TB
    subgraph "User Interface"
        A[ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›] --> B[é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯]
        B --> C[å…¥åŠ›å€¤æ¤œè¨¼]
    end
    
    subgraph "Client Processing"
        C --> D{æ–‡å­—æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯}
        D -->|OK| E[Optimistic UI Update]
        D -->|NG| F[ã‚¨ãƒ©ãƒ¼è¡¨ç¤º]
        E --> G[postMessage Mutation]
    end
    
    subgraph "Network Layer"
        G --> H[GraphQL Request]
        H --> I[HTTP POST to AppSync]
        I --> J{ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šOK?}
        J -->|NG| K[ãƒªãƒˆãƒ©ã‚¤å‡¦ç†]
        K --> I
    end
    
    subgraph "API Processing"
        J -->|OK| L[AppSync Endpoint]
        L --> M[JWT Tokenæ¤œè¨¼]
        M --> N{èªè¨¼æœ‰åŠ¹?}
        N -->|NG| O[401 Unauthorized]
        N -->|OK| P[GraphQL Schemaæ¤œè¨¼]
        P --> Q[Resolverå®Ÿè¡Œ]
    end
    
    subgraph "Business Logic"
        Q --> R[ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹ã‚µãƒ‹ã‚¿ã‚¤ã‚º]
        R --> S[ãƒ«ãƒ¼ãƒ å­˜åœ¨ç¢ºèª]
        S --> T{ãƒ«ãƒ¼ãƒ æœ‰åŠ¹?}
        T -->|NG| U[404 Room Not Found]
        T -->|OK| V[ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä»˜ä¸]
    end
    
    subgraph "Data Persistence"
        V --> W[DynamoDB PutItem]
        W --> X{ä¿å­˜æˆåŠŸ?}
        X -->|NG| Y[500 Database Error]
        X -->|OK| Z[ä¿å­˜å®Œäº†ãƒ¬ã‚¹ãƒãƒ³ã‚¹]
    end
    
    subgraph "Real-time Distribution"
        Z --> AA[DynamoDB Streamsç™ºç«]
        AA --> BB[Subscription Eventç”Ÿæˆ]
        BB --> CC[WebSocketé…ä¿¡]
        CC --> DD[å‚åŠ è€…å…¨å“¡ã«é€šçŸ¥]
    end
    
    subgraph "UI Update"
        DD --> EE[Optimistic UIç¢ºå®š]
        O --> FF[Optimistic UIå–ã‚Šæ¶ˆã—]
        U --> FF
        Y --> FF
    end
```

### 4.2 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãƒ»è¡¨ç¤ºãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant UserA as ğŸ‘¤ User A
    participant UserB as ğŸ‘¤ User B
    participant UIB as ğŸ–¥ï¸ User B UI
    participant WebSocketB as ğŸ”Œ B's WebSocket
    participant AppSync as âš¡ AppSync
    participant EventSystem as ğŸ“¡ Event System
    participant DynamoDB as ğŸ—„ï¸ DynamoDB
    
    Note over UserA,DynamoDB: User A ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿
    
    UserA->>AppSync: postMessage("Hello World!")
    AppSync->>DynamoDB: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿å­˜
    DynamoDB-->>AppSync: ä¿å­˜å®Œäº†
    AppSync-->>UserA: æŠ•ç¨¿æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
    
    Note over UserA,DynamoDB: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡ãƒ•ãƒ­ãƒ¼
    
    AppSync->>EventSystem: onMessagePosted Eventç™ºç”Ÿ
    EventSystem->>WebSocketB: roomIdä¸€è‡´ç¢ºèª
    WebSocketB-->>EventSystem: å—ä¿¡å¯¾è±¡ç¢ºèª
    
    EventSystem->>UIB: Subscription Dataé…ä¿¡
    UIB->>UIB: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆæ›´æ–°
    UIB->>UIB: ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®èª¿æ•´
    UIB->>UIB: æ–°ç€é€šçŸ¥è¡¨ç¤º
    UIB-->>UserB: ğŸ’¬ æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    
    Note over UserA,DynamoDB: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    
    alt WebSocketæ¥ç¶šæ–­
        EventSystem->>WebSocketB: é…ä¿¡è©¦è¡Œ
        WebSocketB-->>EventSystem: æ¥ç¶šã‚¨ãƒ©ãƒ¼
        EventSystem->>EventSystem: å†è©¦è¡Œã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
        EventSystem->>WebSocketB: å†æ¥ç¶šæ™‚ã«é…ä¿¡
    else ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ•ãƒ©ã‚¤ãƒ³
        EventSystem->>EventSystem: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œçŸ¥
        EventSystem->>EventSystem: æœªèª­ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ 
        Note over EventSystem: æ¬¡å›ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ™‚ã«é€šçŸ¥
    end
```

## 5. ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ»æ•´åˆæ€§ãƒ•ãƒ­ãƒ¼

### 5.1 æ¥½è¦³çš„UIæ›´æ–°ã¨åŒæœŸ

```mermaid
stateDiagram-v2
    [*] --> UI_Idle: åˆæœŸçŠ¶æ…‹
    
    UI_Idle --> Optimistic_Update: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ
    Optimistic_Update --> Pending_Server: ã‚µãƒ¼ãƒãƒ¼é€ä¿¡
    
    Pending_Server --> Success_Confirmed: ã‚µãƒ¼ãƒãƒ¼æˆåŠŸ
    Pending_Server --> Error_Occurred: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼
    
    Success_Confirmed --> UI_Idle: UIç¢ºå®š
    Error_Occurred --> Rollback_UI: UIå·»ãæˆ»ã—
    Rollback_UI --> UI_Idle: ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    
    Pending_Server --> Network_Error: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
    Network_Error --> Retry_Queue: ãƒªãƒˆãƒ©ã‚¤ã‚­ãƒ¥ãƒ¼
    Retry_Queue --> Pending_Server: å†è©¦è¡Œ
    Retry_Queue --> Rollback_UI: æœ€å¤§è©¦è¡Œå›æ•°åˆ°é”
    
    note right of Optimistic_Update
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Šã®ãŸã‚
        å³åº§ã«UIæ›´æ–°
    end note
    
    note right of Retry_Queue
        æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§
        è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
    end note
```

### 5.2 ç«¶åˆçŠ¶æ…‹ã®è§£æ±ºãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant UserA as ğŸ‘¤ User A
    participant UserB as ğŸ‘¤ User B
    participant AppSync as âš¡ AppSync
    participant DynamoDB as ğŸ—„ï¸ DynamoDB
    participant ConflictResolver as ğŸ”„ Conflict Resolver
    
    Note over UserA,ConflictResolver: åŒæ™‚ç·¨é›†ã«ã‚ˆã‚‹ç«¶åˆ
    
    par UserA ã®æ“ä½œ
        UserA->>AppSync: updateRoom(id: "room_001", name: "é–‹ç™ºãƒãƒ¼ãƒ ")
        AppSync->>DynamoDB: æ¡ä»¶ä»˜ãæ›´æ–° (version: 1)
    and UserB ã®æ“ä½œ  
        UserB->>AppSync: updateRoom(id: "room_001", name: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆA")
        AppSync->>DynamoDB: æ¡ä»¶ä»˜ãæ›´æ–° (version: 1)
    end
    
    DynamoDB-->>AppSync: UserA: æ›´æ–°æˆåŠŸ (version: 2)
    DynamoDB-->>AppSync: UserB: æ¡ä»¶ä»˜ãæ›´æ–°å¤±æ•—
    
    AppSync-->>UserA: âœ… æ›´æ–°æˆåŠŸ
    AppSync->>ConflictResolver: UserB: ç«¶åˆæ¤œçŸ¥
    
    ConflictResolver->>DynamoDB: æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—
    DynamoDB-->>ConflictResolver: ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ (version: 2)
    
    ConflictResolver-->>UserB: âŒ ç«¶åˆã‚¨ãƒ©ãƒ¼ + æœ€æ–°ãƒ‡ãƒ¼ã‚¿
    
    alt UserB ã®å¯¾å¿œé¸æŠ
        UserB->>AppSync: æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§å†ç·¨é›†
        AppSync->>DynamoDB: æ¡ä»¶ä»˜ãæ›´æ–° (version: 2)
        DynamoDB-->>AppSync: æ›´æ–°æˆåŠŸ (version: 3)
        AppSync-->>UserB: âœ… æ›´æ–°æˆåŠŸ
    else UserB ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        UserB->>UserB: ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        Note over UserB: æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§ç”»é¢æ›´æ–°
    end
```

## 6. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãƒ•ãƒ­ãƒ¼

### 6.1 å¤šå±¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

```mermaid
flowchart LR
    subgraph "Request Flow"
        A[Client Request] --> B{Browser Cache}
        B -->|HIT| C[Browser Response]
        B -->|MISS| D{CDN Cache}
        D -->|HIT| E[CDN Response]
        D -->|MISS| F{AppSync Cache}
        F -->|HIT| G[AppSync Response]
        F -->|MISS| H{Application Cache}
        H -->|HIT| I[App Cache Response]
        H -->|MISS| J[Database Query]
    end
    
    subgraph "Cache TTL Settings"
        K[Static Assets: 1 year]
        L[Room Data: 15 minutes]
        M[Messages: 5 minutes]
        N[User Profile: 30 minutes]
    end
    
    subgraph "Cache Invalidation"
        O[Data Update Event]
        P[Cache Key Invalidation]
        Q[Selective Cache Clear]
    end
    
    C --> K
    E --> L
    G --> M
    I --> N
    
    J --> O
    O --> P
    P --> Q
```

### 6.2 Apollo Client ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TB
    subgraph "Apollo Client Cache"
        A[GraphQL Query] --> B{Normalized Cache}
        B -->|HIT| C[Cache Response]
        B -->|MISS| D[Network Request]
        
        D --> E[AppSync API]
        E --> F[GraphQL Response]
        F --> G[Cache Update]
        G --> H[Component Re-render]
    end
    
    subgraph "Cache Policies"
        I[cache-first: ã‚­ãƒ£ãƒƒã‚·ãƒ¥å„ªå…ˆ]
        J[cache-and-network: ä¸¡æ–¹å®Ÿè¡Œ]
        K[network-only: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã¿]
        L[cache-only: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿]
    end
    
    subgraph "Cache Operations"
        M[writeQuery: æ‰‹å‹•æ›´æ–°]
        N[updateQuery: éƒ¨åˆ†æ›´æ–°]
        O[refetch: å¼·åˆ¶å†å–å¾—]
        P[evict: ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤]
    end
    
    B --> I
    D --> J
    E --> K
    C --> L
    
    G --> M
    H --> N
    A --> O
    G --> P
```

## 7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒ•ãƒ­ãƒ¼

### 7.1 ã‚¨ãƒ©ãƒ¼åˆ†é¡ã¨å‡¦ç†ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TB
    A[API Request] --> B{Request Validation}
    B -->|Invalid| C[400 Bad Request]
    B -->|Valid| D{Authentication}
    
    D -->|Unauthorized| E[401 Unauthorized]
    D -->|Authorized| F{Authorization}
    
    F -->|Forbidden| G[403 Forbidden]
    F -->|Allowed| H{Business Logic}
    
    H -->|Rule Violation| I[422 Unprocessable Entity]
    H -->|Valid| J{Database Operation}
    
    J -->|Not Found| K[404 Not Found]
    J -->|Conflict| L[409 Conflict]
    J -->|Database Error| M[500 Internal Server Error]
    J -->|Success| N[200 OK]
    
    subgraph "Error Handling Strategies"
        O[Client: å†è©¦è¡Œ]
        P[Client: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯]
        Q[Client: ã‚¨ãƒ©ãƒ¼è¡¨ç¤º]
        R[Server: ãƒ­ã‚°è¨˜éŒ²]
        S[Server: ã‚¢ãƒ©ãƒ¼ãƒˆ]
    end
    
    C --> Q
    E --> Q
    G --> Q
    I --> Q
    K --> Q
    L --> O
    M --> P
    M --> R
    M --> S
```

### 7.2 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```mermaid
stateDiagram-v2
    [*] --> Connected: WebSocketæ¥ç¶šæˆåŠŸ
    
    Connected --> Reconnecting: æ¥ç¶šæ–­æ¤œçŸ¥
    Reconnecting --> Connected: å†æ¥ç¶šæˆåŠŸ
    Reconnecting --> Failed: å†æ¥ç¶šå¤±æ•—
    
    Failed --> Backoff: å¾…æ©Ÿæ™‚é–“è¨ˆç®—
    Backoff --> Reconnecting: å†è©¦è¡Œ
    
    Connected --> MessageQueue: é€ä¿¡å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    MessageQueue --> Connected: å†æ¥ç¶šå¾Œé€ä¿¡
    
    Failed --> OfflineMode: æœ€å¤§è©¦è¡Œå›æ•°åˆ°é”
    OfflineMode --> Reconnecting: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾©æ—§æ¤œçŸ¥
    
    note right of Backoff
        æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•:
        1s â†’ 2s â†’ 4s â†’ 8s...
        æœ€å¤§60ç§’
    end note
    
    note right of MessageQueue
        é€ä¿¡å¤±æ•—ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’
        ã‚­ãƒ¥ãƒ¼ã«ä¿å­˜ã—ã€
        å†æ¥ç¶šæ™‚ã«é€ä¿¡
    end note
    
    note right of OfflineMode
        ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¡¨ç¤º
        ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ã¿è¡¨ç¤º
    end note
```

## 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ãƒ»ãƒ•ãƒ­ãƒ¼

### 8.1 ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant App as ğŸ“± ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
    participant Metrics as ğŸ“Š Metrics Collector
    participant CloudWatch as â˜ï¸ CloudWatch
    participant Dashboard as ğŸ“ˆ Dashboard
    participant Alert as ğŸš¨ Alert System
    
    Note over App,Alert: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
    
    App->>Metrics: API Response Time: 120ms
    App->>Metrics: Cache Hit Rate: 85%
    App->>Metrics: Error Count: 2
    App->>Metrics: Active Users: 150
    
    Metrics->>CloudWatch: Batch Metricsé€ä¿¡
    CloudWatch->>CloudWatch: ãƒ‡ãƒ¼ã‚¿é›†ç´„ãƒ»ä¿å­˜
    
    CloudWatch->>Dashboard: ãƒ¡ãƒˆãƒªã‚¯ã‚¹å¯è¦–åŒ–
    Dashboard-->>Dashboard: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚°ãƒ©ãƒ•æ›´æ–°
    
    CloudWatch->>Alert: é–¾å€¤ãƒã‚§ãƒƒã‚¯
    
    alt ç•°å¸¸å€¤æ¤œçŸ¥
        Alert->>Alert: ã‚¢ãƒ©ãƒ¼ãƒˆç”Ÿæˆ
        Alert->>Dashboard: ğŸš¨ Critical Alertè¡¨ç¤º
        Alert->>Alert: Slack/Emailé€šçŸ¥
    else æ­£å¸¸å€¤
        Alert->>Dashboard: âœ… Normal Status
    end
    
    Note over App,Alert: è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°é€£æº
    
    CloudWatch->>CloudWatch: ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãƒ¡ãƒˆãƒªã‚¯ã‚¹è©•ä¾¡
    CloudWatch->>App: Auto Scalingå®Ÿè¡Œ
```

### 8.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ç›£è¦–

```mermaid
flowchart TB
    subgraph "Frontend Metrics"
        A[Page Load Time] --> B[First Contentful Paint]
        B --> C[Largest Contentful Paint]
        C --> D[Cumulative Layout Shift]
        D --> E[First Input Delay]
    end
    
    subgraph "Application Metrics"
        F[GraphQL Query Time] --> G[Cache Hit Rate]
        G --> H[WebSocket Connection Status]
        H --> I[Message Delivery Latency]
    end
    
    subgraph "User Behavior Metrics"
        J[Session Duration] --> K[Message Frequency]
        K --> L[Room Participation Rate]
        L --> M[Feature Usage Patterns]
    end
    
    subgraph "Quality Metrics"
        N[Error Rate by Feature]
        O[User Satisfaction Score]
        P[Accessibility Compliance]
        Q[Mobile Responsiveness]
    end
    
    E --> F
    I --> J
    M --> N
    N --> O
    O --> P
    P --> Q
    
    subgraph "Alerting Thresholds"
        R[Load Time > 3s: Warning]
        S[Error Rate > 1%: Critical]
        T[WebSocket Disconnect > 5%: Warning]
        U[Message Delay > 1s: Critical]
    end
```

---

*ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å…¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã‚’åŒ…æ‹¬çš„ã«èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚å„ãƒ•ãƒ­ãƒ¼ã¯å®Ÿéš›ã®å®Ÿè£…ã«åŸºã¥ã„ã¦ãŠã‚Šã€ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œç†è§£ã¨æœ€é©åŒ–ã«æ´»ç”¨ã§ãã¾ã™ã€‚*
