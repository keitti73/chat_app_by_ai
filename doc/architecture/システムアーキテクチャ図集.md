# チャットアプリ - システムアーキテクチャ図集

このドキュメントでは、チャットアプリの様々なアーキテクチャ図をMermaidを使用して詳細に説明します。

## 1. 全体アーキテクチャ

### 1.1 高レベルアーキテクチャ

```mermaid
flowchart TB
    subgraph "Users"
        U1[Web Browser]
        U2[Mobile App]
    end
    
    subgraph "CDN Layer"
        C1[CloudFront]
        C2[S3 Static Hosting]
    end
    
    subgraph "Frontend Layer"
        F1[React Application]
        F2[Vite Build]
    end
    
    subgraph "API Layer"
        A1[AWS AppSync]
        A2[GraphQL Schema]
        A3[JavaScript Resolvers]
    end
    
    subgraph "Authentication"
        AU1[Cognito User Pool]
        AU2[Cognito Identity]
    end
    
    subgraph "Data Layer"
        D1[Room Table]
        D2[Message Table]
        D3[DynamoDB Streams]
    end
    
    subgraph "Monitoring"
        M1[CloudWatch]
        M2[X-Ray Tracing]
    end
    
    U1 --> C1
    U2 --> C1
    C1 --> C2
    C1 --> F1
    F1 --> A1
    A1 --> AU1
    A1 --> A3
    A3 --> D1
    A3 --> D2
    D1 --> D3
    D2 --> D3
    A1 --> M1
    A3 --> M2
    
    style A1 fill:#ff6b6b
    style D1 fill:#4ecdc4
    style D2 fill:#4ecdc4
    style M1 fill:#ffd93d
```

### 1.2 データフロー概要

```mermaid
flowchart TB
    subgraph "User Interaction"
        A[ユーザー操作] --> B[React Component]
        B --> C[GraphQL Client]
    end
    
    subgraph "API Processing"
        C --> D[AWS AppSync]
        D --> E[認証チェック]
        E --> F[GraphQL Schema Validation]
        F --> G[Resolver実行]
    end
    
    subgraph "Data Operations"
        G --> H[DynamoDB操作]
        H --> I[レスポンス生成]
    end
    
    subgraph "Real-time Updates"
        H --> J[DynamoDB Streams]
        J --> K[Subscription通知]
        K --> L[WebSocket配信]
    end
    
    I --> C
    L --> B
```

## 2. 認証・認可フロー

### 2.1 ユーザー認証フロー

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant React as React App
    participant Cognito as Cognito User Pool
    participant AppSync as AWS AppSync
    participant DynamoDB as DynamoDB
    
    Note over User,DynamoDB: 新規ユーザー登録フロー
    
    User->>React: ユーザー登録
    React->>Cognito: signup(username, password, email)
    Cognito-->>React: 確認コード送信要求
    
    User->>React: 確認コード入力
    React->>Cognito: confirmSignUp(code)
    Cognito-->>React: 登録完了
    
    Note over User,DynamoDB: ログインフロー
    
    User->>React: ログイン
    React->>Cognito: signIn(username, password)
    Cognito-->>React: JWT Token (ID, Access, Refresh)
    
    React->>AppSync: GraphQL Request + Authorization Header
    AppSync->>Cognito: Token検証
    Cognito-->>AppSync: ユーザー情報 (claims)
    
    AppSync->>DynamoDB: データ操作 (as authenticated user)
    DynamoDB-->>AppSync: データレスポンス
    AppSync-->>React: GraphQL Response
    React-->>User: UI更新
```

### 2.2 トークンリフレッシュフロー

```mermaid
flowchart TB
    A[API Request] --> B{Access Token有効?}
    B -->|有効| C[API実行]
    B -->|無効/期限切れ| D{Refresh Token有効?}
    
    D -->|有効| E[Token Refresh]
    D -->|無効| F[再ログイン要求]
    
    E --> G[新しいAccess Token取得]
    G --> H[元のリクエスト再実行]
    H --> C
    
    F --> I[ログイン画面表示]
    C --> J[成功レスポンス]
```

## 3. リアルタイム通信アーキテクチャ

### 3.1 WebSocket接続とSubscription

```mermaid
sequenceDiagram
    participant ClientA as Client A
    participant ClientB as Client B
    participant AppSync as AppSync WebSocket
    participant EventBus as Event Distribution
    participant DynamoDB as DynamoDB
    
    Note over ClientA,DynamoDB: WebSocket接続とSubscription登録
    
    ClientA->>AppSync: WebSocket接続 + JWT Token
    AppSync-->>ClientA: 接続確立
    
    ClientA->>AppSync: Subscription: onMessagePosted(roomId: "room_001")
    AppSync-->>ClientA: Subscription登録完了
    
    ClientB->>AppSync: WebSocket接続 + JWT Token  
    AppSync-->>ClientB: 接続確立
    
    ClientB->>AppSync: Subscription: onMessagePosted(roomId: "room_001")
    AppSync-->>ClientB: Subscription登録完了
    
    Note over ClientA,DynamoDB: メッセージ投稿とリアルタイム配信
    
    ClientA->>AppSync: Mutation: postMessage(roomId: "room_001", text: "Hello")
    AppSync->>DynamoDB: メッセージ保存
    DynamoDB-->>AppSync: 保存完了
    
    AppSync->>EventBus: MessagePosted Event
    EventBus->>AppSync: Filter: roomId = "room_001"
    
    AppSync-->>ClientA: Subscription: 新しいメッセージ
    AppSync-->>ClientB: Subscription: 新しいメッセージ
```

### 3.2 イベント配信メカニズム

```mermaid
flowchart LR
    subgraph "Event Sources"
        A[createRoom Mutation]
        B[postMessage Mutation]
        C[updateRoom Mutation]
        D[deleteRoom Mutation]
    end
    
    subgraph "Event Processing"
        E[Event Trigger]
        F[Subscription Filter]
        G[Authorization Check]
    end
    
    subgraph "Event Distribution"
        H[Global Events<br/>onRoomCreated]
        I[Room-specific Events<br/>onMessagePosted]
        J[User-specific Events<br/>onRoomUpdated]
    end
    
    subgraph "Connected Clients"
        K[All Clients]
        L[Room Participants]
        M[Room Owner]
    end
    
    A --> E
    B --> E
    C --> E
    D --> E
    
    E --> F
    F --> G
    
    G --> H
    G --> I
    G --> J
    
    H --> K
    I --> L
    J --> M
```

## 4. データ処理パイプライン

### 4.1 メッセージ処理パイプライン

```mermaid
flowchart TB
    subgraph "Input Processing"
        A[GraphQL Mutation] --> B[Input Validation]
        B --> C[Authentication Check]
        C --> D[Authorization Check]
    end
    
    subgraph "Business Logic"
        D --> E[Room Existence Check]
        E --> F[Message Processing]
        F --> G[Metadata Addition]
    end
    
    subgraph "Data Persistence"
        G --> H[DynamoDB PutItem]
        H --> I[Write Confirmation]
    end
    
    subgraph "Event Processing"
        I --> J[DynamoDB Streams]
        J --> K[Lambda Trigger]
        K --> L[Event Publishing]
    end
    
    subgraph "Real-time Distribution"
        L --> M[Subscription Filtering]
        M --> N[WebSocket Notification]
    end
    
    subgraph "Error Handling"
        B --> O[Validation Error]
        C --> P[Auth Error]
        D --> Q[Authorization Error]
        E --> R[Business Logic Error]
        H --> S[Database Error]
    end
```

### 4.2 複雑クエリ処理（myActiveRooms）

```mermaid
flowchart TB
    A[myActiveRooms Query] --> B[ユーザー認証確認]
    B --> C[MessageテーブルのUser-Index Query]
    C --> D[ユーザーの全メッセージ取得]
    D --> E[roomIdの重複除去]
    E --> F{Room数チェック}
    
    F -->|少数| G[個別Room情報取得]
    F -->|多数| H[BatchGetItem使用]
    
    G --> I[各RoomのgetRoom Query実行]
    H --> J[一括Room情報取得]
    
    I --> K[結果マージ]
    J --> K
    
    K --> L[レスポンス生成]
    
    subgraph "Optimization Options"
        M[Pipeline Resolver]
        N[Caching Layer]
        O[DataLoader Pattern]
    end
```

## 5. 監視・ログ・メトリクス

### 5.1 監視アーキテクチャ

```mermaid
flowchart TB
    subgraph "Application Layer"
        A1[AppSync APIs]
        A2[DynamoDB]
        A3[Cognito]
        A4[Lambda Functions]
    end
    
    subgraph "Monitoring Services"
        M1[CloudWatch]
        M2[X-Ray Tracing]
        M3[CloudWatch Logs]
        M4[Custom Metrics]
    end
    
    subgraph "Alerting & Notification"
        AL1[SNS Notifications]
        AL2[Slack Integration]
        AL3[PagerDuty]
    end
    
    subgraph "Dashboards & Analytics"
        D1[Grafana]
        D2[QuickSight]
        D3[Kibana/OpenSearch]
    end
    
    A1 --> M1
    A2 --> M1
    A3 --> M1
    A4 --> M2
    
    M1 --> AL1
    M4 --> AL2
    
    M3 --> D1
    M1 --> D2
    
    style M1 fill:#ff6b6b
    style AL1 fill:#4ecdc4
    style D1 fill:#ffd93d
```

### 5.2 ログ集約パイプライン

```mermaid
flowchart LR
    subgraph "Log Sources"
        A[AppSync Logs]
        B[DynamoDB Logs]
        C[Cognito Logs]
        D[Application Logs]
    end
    
    subgraph "Log Processing"
        E[CloudWatch Logs]
        F[Log Filters]
        G[Log Streams]
    end
    
    subgraph "Log Storage & Analysis"
        H[S3 Archive]
        I[OpenSearch]
        J[Kinesis Data Streams]
    end
    
    subgraph "Alerting & Dashboards"
        K[CloudWatch Alarms]
        L[Custom Dashboards]
        M[Log Analysis]
    end
    
    A --> E
    B --> E
    C --> E
    D --> E
    
    E --> F
    F --> G
    
    G --> H
    G --> I
    G --> J
    
    I --> K
    I --> L
    I --> M
```

## 6. セキュリティアーキテクチャ

### 6.1 多層防御アーキテクチャ

```mermaid
flowchart TB
    subgraph "Network Security"
        A[CloudFront WAF] --> B[DDoS Protection]
        B --> C[IP Allowlisting]
        C --> D[Rate Limiting]
    end
    
    subgraph "Application Security"
        D --> E[HTTPS/TLS 1.3]
        E --> F[JWT Token Validation]
        F --> G[Input Sanitization]
        G --> H[GraphQL Query Depth Limiting]
    end
    
    subgraph "Authentication & Authorization"
        H --> I[Cognito User Pool]
        I --> J[Multi-Factor Authentication]
        J --> K[Role-Based Access Control]
        K --> L[Resource-Level Permissions]
    end
    
    subgraph "Data Security"
        L --> M[Encryption at Rest]
        M --> N[Encryption in Transit]
        N --> O[Field-Level Encryption]
        O --> P[Audit Logging]
    end
```

### 6.2 データ暗号化フロー

```mermaid
sequenceDiagram
    participant Client as クライアント
    participant CloudFront as CloudFront
    participant AppSync as AppSync
    participant KMS as AWS KMS
    participant DynamoDB as DynamoDB
    
    Note over Client,DynamoDB: データ暗号化の全フロー
    
    Client->>CloudFront: HTTPS Request (TLS 1.3)
    CloudFront->>AppSync: Encrypted in Transit
    
    AppSync->>KMS: データキー要求
    KMS-->>AppSync: 暗号化キー提供
    
    AppSync->>DynamoDB: 暗号化されたデータ保存
    Note over DynamoDB: Server-side Encryption
    
    DynamoDB-->>AppSync: 暗号化されたレスポンス
    AppSync->>KMS: 復号化キー要求
    KMS-->>AppSync: 復号化キー提供
    
    AppSync-->>CloudFront: 暗号化されたレスポンス
    CloudFront-->>Client: HTTPS Response (TLS 1.3)
```

## 8. 災害復旧・バックアップアーキテクチャ

### 8.1 マルチリージョン構成

```mermaid
flowchart TB
    subgraph "Global Services"
        G1[Route 53]
        G2[CloudFront]
        G3[S3 Cross-Region Backup]
    end
    
    subgraph "Primary Region (us-east-1)"
        P1[AppSync Primary]
        P2[DynamoDB Primary]
        P3[Cognito Primary]
    end
    
    subgraph "Secondary Region (us-west-2)"
        S1[AppSync Secondary]
        S2[DynamoDB Secondary]
        S3[Cognito Secondary]
    end
    
    G1 --> P1
    G1 --> S1
    
    P2 --> S2
    P3 --> S3
    
    P2 --> G3
    S2 --> G3
    
    style P1 fill:#e1f5fe
    style S1 fill:#f3e5f5
    style G1 fill:#e8f5e8
    style G3 fill:#fff3e0
```

### 8.2 自動フェイルオーバー仕組み

```mermaid
flowchart TB
    A[Health Check] --> B{Primary Region OK?}
    B -->|正常| C[通常運用継続]
    B -->|異常| D[Health Check失敗]
    
    D --> E[Route 53 DNS切り替え]
    E --> F[Secondary Regionへトラフィック誘導]
    F --> G[DynamoDB Global Tablesアクティブ化]
    G --> H[Cognito Secondary Pool使用]
    
    H --> I[サービス復旧確認]
    I --> J{Primary Region復旧?}
    J -->|復旧| K[フェイルバック実行]
    J -->|未復旧| L[Secondary Region継続運用]
    
    K --> M[データ同期確認]
    M --> N[Primary Regionへ切り戻し]
    N --> C
```

## 9. 開発・デプロイメントパイプライン

### 9.1 CI/CDパイプライン

```mermaid
flowchart TD
    A["feature/new-api"] --> B["development"]
    B --> C["開発環境デプロイ"]
    C --> D["統合テスト"]
    D --> E["main"]
    E --> F["staging環境デプロイ"]
    F --> G["E2Eテスト"]
    G --> H["パフォーマンステスト"]
    H --> I["release"]
    I --> J["production環境デプロイ"]
    J --> K["本番監視開始"]
    K --> L["main（リリース完了）"]
    
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#333,stroke-width:2px
    style E fill:#bfb,stroke:#333,stroke-width:2px
    style I fill:#fbb,stroke:#333,stroke-width:2px
    style L fill:#bfb,stroke:#333,stroke-width:2px
```

### 9.2 デプロイメントアーキテクチャ

```mermaid
flowchart LR
    subgraph "Source Control"
        A[GitHub Repository] --> B[Pull Request]
        B --> C[Code Review]
        C --> D[Merge to Main]
    end
    
    subgraph "CI Pipeline"
        D --> E[GitHub Actions]
        E --> F[Linting & Testing]
        F --> G[Build Application]
        G --> H[Infrastructure as Code]
    end
    
    subgraph "CD Pipeline"
        H --> I[Deploy to Staging]
        I --> J[Integration Tests]
        J --> K[Security Scans]
        K --> L[Deploy to Production]
    end
    
    subgraph "Monitoring"
        L --> M[Deployment Monitoring]
        M --> N[Health Checks]
        N --> O[Rollback if Needed]
    end
```

---

*このドキュメントは、チャットアプリのシステムアーキテクチャを包括的に図解しています。各図は実際の実装と対応しており、システムの理解と保守に役立ちます。*
