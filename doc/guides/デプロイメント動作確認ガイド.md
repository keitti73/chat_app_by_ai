# 🚀 デプロイメント・動作確認ガイド

## 📋 概要

このガイドでは、AI感情分析機能を含むチャットアプリの完全なデプロイメント手順と動作確認方法を説明します。

## ✅ デプロイ前チェックリスト

### 必須ファイル確認
- [x] `src/components/ChatRoom.jsx` - AI機能付きUI
- [x] `src/graphql/mutations.js` - GraphQL操作
- [x] `schema.graphql` - スキーマ定義
- [x] `infra/appsync.tf` - AppSync設定
- [x] `infra/resolvers.tf` - Resolver設定
- [x] `resolvers/Lambda_analyzeMessageSentiment.js` - Lambda実装

### 整合性確認
- [x] **パラメータ整合性**: `analyzeMessageSentiment(messageId: ID!, text: String!)`
- [x] **フロントエンド変数**: `variables: { messageId, text: messageText }`
- [x] **Lambda引数**: `event.arguments.messageId`, `event.arguments.text`
- [x] **レスポンス形式**: `SentimentAnalysis`型対応完了

## 🚀 デプロイ手順

### 1. 依存関係のインストール
```bash
# Node.js依存関係のインストール
npm install
```

### 2. インフラのデプロイ
```bash
# Terraformディレクトリに移動
cd infra

# Terraformの初期化（初回のみ）
terraform init

# 設定の検証
terraform validate

# デプロイプランの確認
terraform plan

# インフラのデプロイ実行
terraform apply
```

### 3. 環境変数の設定
```bash
# 設定例をコピー
cp .env.example .env

# .envファイルを編集（terraform applyの出力値を使用）
# VITE_AWS_REGION=
# VITE_USER_POOL_ID=
# VITE_USER_POOL_CLIENT_ID=
# VITE_GRAPHQL_URL=
```

### 4. フロントエンドの起動
```bash
# 開発サーバーの起動
npm run dev

# ブラウザで http://localhost:3000 を開く
```

## 📝 動作確認手順

### 1. 基本機能の確認
1. **ユーザー登録・ログイン**
   - 新規アカウント作成
   - メール認証
   - ログイン機能

2. **チャットルーム機能**
   - ルーム作成
   - ルーム一覧表示
   - メッセージ送信
   - リアルタイム受信

### 2. AI感情分析機能の確認
1. **フロントエンドUI確認**
   - チャットルームでメッセージに「🤖 感情分析」ボタンが表示される
   - ボタンクリック時のローディング状態表示

2. **分析実行確認**
   - ボタンクリックでLambda関数が実行される
   - エラー無く処理が完了する

3. **結果表示確認**
   - 感情（ポジティブ/ネガティブ/中立/混合）が正しく表示される
   - 確信度スコア（パーセンテージ）が表示される
   - 言語検出結果が表示される（日本語→JA、英語→EN等）
   - 適切性フラグが必要に応じて表示される

### 3. 詳細テストケース

#### ポジティブメッセージのテスト
```
テストメッセージ: "今日はとても楽しい一日でした！ありがとう！"
期待結果: 
- 感情: POSITIVE
- ポジティブスコア: 70%以上
- 言語: JA
```

#### ネガティブメッセージのテスト
```
テストメッセージ: "This is really disappointing and frustrating."
期待結果:
- 感情: NEGATIVE
- ネガティブスコア: 70%以上
- 言語: EN
```

#### 中立メッセージのテスト
```
テストメッセージ: "今日の天気は曇りです。"
期待結果:
- 感情: NEUTRAL
- 中立スコア: 高い値
- 言語: JA
```

## 🔍 トラブルシューティング

### よくある問題と解決方法

#### 1. GraphQLエラー
**症状**: 感情分析ボタンクリック時にエラー
**原因**: スキーマとフロントエンドの不整合
**解決**: パラメータ名と型の確認

#### 2. Lambda実行エラー
**症状**: 分析が実行されない
**原因**: IAMロール権限不足
**解決**: `infra/appsync.tf`のIAMポリシー確認

#### 3. UI表示エラー
**症状**: 結果が表示されない
**原因**: フロントエンドの状態管理
**解決**: `ChatRoom.jsx`の状態変数確認

### デバッグ手順

1. **ブラウザDevToolsでの確認**
   ```javascript
   // コンソールでGraphQLリクエスト確認
   console.log('GraphQL Request:', {
     query: analyzeMessageSentimentMutation,
     variables: { messageId, text }
   });
   ```

2. **AWS CloudWatchログ確認**
   - AppSyncのリクエスト/レスポンスログ
   - Lambda関数の実行ログ
   - エラーメッセージの詳細

3. **Terraform状態確認**
   ```bash
   # リソース状態の確認
   terraform state list
   terraform state show aws_appsync_resolver.analyze_message_sentiment
   ```

## 📊 パフォーマンス監視

### 監視項目
- **レスポンス時間**: 感情分析の実行時間
- **成功率**: エラー無く完了する割合
- **Lambda実行時間**: AWS Comprehendの処理時間
- **DynamoDB読み書き**: データベースアクセスパターン

### 最適化ポイント
- **キャッシュ活用**: 同じメッセージの重複分析回避
- **バッチ処理**: 複数メッセージの一括分析
- **並列実行**: フロントエンドでの非同期処理

## 🎯 本番環境移行

### 本番環境の追加設定
1. **環境変数の本番値設定**
2. **ドメイン設定とSSL証明書**
3. **CloudWatch監視とアラート設定**
4. **バックアップと復旧手順**

### セキュリティ強化
- **API レート制限**設定
- **DDoS保護**有効化
- **ログ監査**体制整備

---

**✅ このガイドに従ってデプロイすることで、AI感情分析機能を含む完全なチャットアプリが稼働します！**
